<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspection System ‚Äî MVP</title>
  <style>
    :root{--bg1:#0b2a55;--bg2:#134b8a;--accent:#1e88e5;--accent-2:#90caf9;--ok:#1b5e20;--danger:#c62828;--card:#ffffff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100dvh;color:#0f172a;display:flex;align-items:center;justify-content:center}
    .container{width:min(920px,95vw);}
    .card{background:var(--card);border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden}
    header{padding:28px 28px 18px;background:transparent;color:#e3f2fd;text-align:center}
    header h1{margin:0;font-weight:700;font-size:clamp(20px,3.6vw,28px)}
    header p{margin:.35rem 0 0;color:#cfe8ff}

    .section{padding:20px clamp(16px,4vw,28px) 26px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:13px;color:#334155;margin:6px 2px}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:12px 12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;outline:none;transition:border .15s,box-shadow .15s}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(30,136,229,.15)}
    .muted{color:var(--muted);font-size:12px}

    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer;transition:transform .06s ease,filter .15s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:white}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent;color:var(--accent);border:1px dashed var(--accent)}
    .btn-danger{background:var(--danger);color:#fff}

    .toolbar{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
    .badge{background:#e8f2ff;color:#0b3a72;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:0}
    .lot-row{display:grid;grid-template-columns:2fr 1fr auto;gap:10px;align-items:center}
    .lot-actions{display:flex;gap:8px;justify-content:flex-end}

    /* Views */
    .screen{display:none}
    .screen.active{display:block}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:16px;max-width:420px;width:100%;box-shadow:0 10px 35px rgba(0,0,0,.35);padding:22px}
    .modal h3{margin:0 0 6px}
    .modal p{margin:0 0 16px;color:#374151}
    .modal .actions{display:flex;justify-content:flex-end;gap:10px}

    /* Login */
    .login-hero{padding:28px;text-align:center;color:white}
    .login-hero h2{margin:0 0 6px;font-size:clamp(22px,6vw,30px)}
    .login-hero p{margin:0;color:#cfe8ff}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>Inspection System</h1>
        <p>Minimal Viable Frontend ‚Äî GitHub Pages</p>
      </header>

      <!-- LOGIN SCREEN -->
      <section id="screen-login" class="section screen active">
        <div class="login-hero">
          <h2>üîë Login</h2>
          <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p>
        </div>
        <div class="row">
          <div>
            <label>Username</label>
            <input id="login-username" placeholder="‡πÄ‡∏ä‡πà‡∏ô champ" />
          </div>
          <div>
            <label>Password</label>
            <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="toolbar">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
        <div class="section" style="padding-top:8px">
          <span class="muted">* ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô MVP: ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ) ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô Authentication</span>
        </div>
      </section>

      <!-- FORM SCREEN -->
      <section id="screen-form" class="section screen">
        <div class="row">
          <div><label>Employee</label>
            <input id="employee" readonly />
          </div>
          <div><label>Shift</label>
            <select id="shift">
              <option value="A">A</option>
              <option value="B">B</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Part No.</label>
            <input id="partNo" list="partNoList" placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC-123" oninput="updatePartName()" />
            <datalist id="partNoList"></datalist>
          </div>
          <div>
            <label>Part Name</label>
           <input id="partNo" list="partNoList" placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC-123"
       oninput="updatePartName()" onchange="updatePartName()" />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Lots & Quantity</label>
          <div id="lotTable"></div>
          <div class="toolbar">
            <button class="btn btn-ghost" onclick="addLotRow()">+ Add Lot</button>
          </div>
        </div>

        <div class="row row-1">
          <div>
            <label>Note</label>
            <textarea id="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô OK / NG / Remark"></textarea>
          </div>
        </div>

        <div class="toolbar">
          <span id="loginBadge" class="badge"></span>
          <button class="btn" onclick="onLogout()">Logout</button>
          <button class="btn btn-primary" onclick="onSave()">Save</button>
        </div>
      </section>

    </div>
  </div>

  <!-- Modal / Popup -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle">Message</h3>
      <p id="modalBody">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
      <div class="actions">
        <button class="btn" onclick="closeModal()">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIG ====
    const API_URL = "https://script.google.com/macros/s/AKfycbzTzPjZUciFgsPJ3bk7Btt6waolx0CBaklIA5lTC-gNelCFA_-6x0CzUPbzdqp8AMxH/exec"; // TODO: ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å GAS Deploy

    // Master data: ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï `part_list` ‡∏ú‡πà‡∏≤‡∏ô GAS
    let PARTS_LC = {};
function normalizeKey(s){ return (s||'').toString().trim().toLowerCase(); }


async function loadParts(){
  try{
    const resp = await fetch(API_URL + '?action=parts');
    const data = await resp.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if(!data.ok){ console.warn('Load parts failed:', data.error); return; }
   PARTS = {};
PARTS_LC = {};
for(const p of (data.parts||[])){
  if(p && p.partNo){
    const no = String(p.partNo);
    const name = String(p.partName||'');
    PARTS[no] = name;
    PARTS_LC[normalizeKey(no)] = name; // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö lower-case ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÅ‡∏Ñ‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå
  }
}
    fillPartNoList(); // ‚úÖ ‡πÄ‡∏ï‡∏¥‡∏° datalist ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
  }catch(err){ console.warn('Load parts error:', err); }
}

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° datalist ‡∏Ç‡∏≠‡∏á Part No.
    function fillPartNoList(){
      const dl = document.getElementById('partNoList');
      dl.innerHTML = '';
      Object.keys(PARTS).forEach(k=>{
        const opt = document.createElement('option');
        opt.value = k;
        dl.appendChild(opt);
      });
    }

    // ==== View helpers ====
    function showScreen(id){
      for (const el of document.querySelectorAll('.screen')) el.classList.remove('active');
      document.getElementById(id).classList.add('active');
    }
    function showModal(title, body){
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = body;
      document.getElementById('overlay').classList.add('show');
    }
    function closeModal(){ document.getElementById('overlay').classList.remove('show'); }

    // ==== Login (MVP stub) ====
    function onLogin(){
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value; // not used in MVP
      if(!u){ return showModal('Login failed', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username'); }
      localStorage.setItem('loggedUser', u);
      document.getElementById('employee').value = u;
      document.getElementById('loginBadge').textContent = `Logged in as: ${u}`;
      showScreen('screen-form');
    }
    function onLogout(){
      localStorage.removeItem('loggedUser');
      // reset
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      showScreen('screen-login');
    }

    // ==== Part link ====
   function updatePartName(){
  const pnRaw = document.getElementById('partNo').value;
  const pn = pnRaw.trim();
  const name = PARTS[pn] || PARTS_LC[normalizeKey(pn)] || '';
  document.getElementById('partName').value = name;
}


    // ==== Lots table ====
    function lotRowTemplate(idx){
      return `
        <div class="lot-row" data-index="${idx}">
          <input placeholder="Lot No." class="lot-no" />
          <input type="number" min="0" step="1" placeholder="Qty" class="lot-qty" />
          <div class="lot-actions">
            <button class="btn btn-danger" onclick="removeLotRow(${idx})">Remove</button>
          </div>
        </div>
      `;
    }
    let lotIndex = 0;
    function addLotRow(){
      const wrap = document.getElementById('lotTable');
      const div = document.createElement('div');
      div.innerHTML = lotRowTemplate(++lotIndex);
      wrap.appendChild(div.firstElementChild);
    }
    function removeLotRow(idx){
      const row = document.querySelector(`.lot-row[data-index="${idx}"]`);
      if(row) row.remove();
    }
    function clearLots(){
      document.getElementById('lotTable').innerHTML = '';
      lotIndex = 0; addLotRow();
    }

    // ==== Save ====
    async function onSave(){
      try{
        const employee = document.getElementById('employee').value.trim();
        const partNo   = document.getElementById('partNo').value.trim();
        const partName = document.getElementById('partName').value.trim();
        const shift    = document.getElementById('shift').value;
        const note     = document.getElementById('note').value.trim();
        const userId   = employee ? (employee.toLowerCase().replace(/\s+/g,'') ) : '';

        // collect lots
        const lots = Array.from(document.querySelectorAll('.lot-row')).map(r=>({
          lotNo: r.querySelector('.lot-no').value.trim(),
          quantity: Number(r.querySelector('.lot-qty').value || '0')
        })).filter(x=>x.lotNo);

        if(!employee || !partNo || lots.length===0){
          return showModal('Invalid form', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Employee, Part No. ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á Lot/Quantity');
        }

        const payload = { employee, userId, partNo, partName, shift, note, lots };

        // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á headers ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á preflight CORS
        const resp = await fetch(API_URL, { method:'POST', body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=>({ok:false,error:'Invalid JSON response'}));

        if(!data.ok){
          return showModal('Save failed', data.error || 'Unknown error');
        }

        // success
        showModal('Saved successfully!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        // ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏õ‡∏Ñ: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á Save
        document.getElementById('partNo').value = '';
        document.getElementById('partName').value = '';
        document.getElementById('note').value = '';
        clearLots();

      }catch(err){
        showModal('Save failed', String(err));
      }
    }

    // ==== init ====
    (async function init(){
      fillPartNoList();
      clearLots();
      const u = localStorage.getItem('loggedUser');
      if(u){
        document.getElementById('employee').value = u;
        document.getElementById('loginBadge').textContent = `Logged in as: ${u}`;
        showScreen('screen-form');
      }
    })();
  </script>
</body>
</html>


