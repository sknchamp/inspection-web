<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspection System ‚Äî MVP</title>
  <style>
    :root{--bg1:#0b2a55;--bg2:#134b8a;--accent:#1e88e5;--accent-2:#90caf9;--ok:#1b5e20;--danger:#c62828;--card:#ffffff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100dvh;color:#0f172a;display:flex;align-items:center;justify-content:center}
    .container{width:min(1100px,95vw);}
    .card{background:var(--card);border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden}
    header{padding:28px 28px 18px;background:transparent;color:#e3f2fd;text-align:center}
    header h1{margin:0;font-weight:700;font-size:clamp(20px,3.6vw,28px)}
    header p{margin:.35rem 0 0;color:#cfe8ff}

    .section{padding:20px clamp(16px,4vw,28px) 26px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:13px;color:#334155;margin:6px 2px}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:12px 12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;outline:none;transition:border .15s,box-shadow .15s}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(30,136,229,.15)}
    .muted{color:var(--muted);font-size:12px}

    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer;transition:transform .06s ease,filter .15s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:white}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent;color:var(--accent);border:1px dashed var(--accent)}
    .btn-danger{background:var(--danger);color:#fff}

    .toolbar{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
    .badge{background:#e8f2ff;color:#0b3a72;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:0}
    .lot-row{display:grid;grid-template-columns:2fr 1fr auto;gap:10px;align-items:center}
    .lot-actions{display:flex;gap:8px;justify-content:flex-end}

    /* Views */
    .screen{display:none}
    .screen.active{display:block}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:16px;max-width:420px;width:100%;box-shadow:0 10px 35px rgba(0,0,0,.35);padding:22px}
    .modal h3{margin:0 0 6px}
    .modal p{margin:0 0 16px;color:#374151}
    .modal .actions{display:flex;justify-content:flex-end;gap:10px}

    /* Login */
    .login-hero{padding:28px;text-align:center;color:white}
    .login-hero h2{margin:0 0 6px;font-size:clamp(22px,6vw,30px)}
    .login-hero p{margin:0;color:#cfe8ff}

    /* Dashboard */
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi .cardk{background:#f8fafc;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .kpi .title{font-size:12px;color:#64748b}
    .kpi .value{font-size:22px;font-weight:700;margin-top:6px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:12px}
    canvas{max-width:100%;height:320px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>Inspection System</h1>
        <p>Minimal Viable Frontend ‚Äî GitHub Pages</p>
      </header>

      <!-- Top Nav -->
      <div class="section" style="padding-top:8px;padding-bottom:0">
        <div class="toolbar" style="justify-content:flex-start;gap:8px">
          <button class="btn btn-ghost" onclick="showScreen('screen-form')">‚ûï New Entry</button>
          <button class="btn btn-ghost" onclick="openHistory()">üìú History / Search</button>
          <button class="btn btn-ghost" onclick="openDashboard()">üìä Dashboard</button>
        </div>
      </div>

      <!-- LOGIN SCREEN -->
      <section id="screen-login" class="section screen active">
        <div class="login-hero">
          <h2>üîë Login</h2>
          <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p>
        </div>
        <div class="row">
          <div>
            <label>Username</label>
            <input id="login-username" placeholder="‡πÄ‡∏ä‡πà‡∏ô champ" />
          </div>
          <div>
            <label>Password</label>
            <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="toolbar">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
        <div class="section" style="padding-top:8px">
          <span class="muted">* ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô MVP: ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ) ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô Authentication</span>
        </div>
      </section>

      <!-- FORM SCREEN -->
      <section id="screen-form" class="section screen">
        <div class="row">
          <div><label>Employee</label>
            <input id="employee" readonly />
          </div>
          <div><label>Shift</label>
            <select id="shift">
              <option value="A">A</option>
              <option value="B">B</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Part No.</label>
            <input id="partNo"
                   list="partNoList"
                   placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC-123"
                   oninput="updatePartName()"
                   onchange="updatePartName()" />
            <datalist id="partNoList"></datalist>
          </div>
          <div>
            <label>Part Name</label>
            <input id="partName"
                   readonly tabindex="-1" onfocus="this.blur()" inputmode="none"
                   placeholder="‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Part No."
                   style="background:#f8fafc; cursor:not-allowed;" />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Lots & Quantity</label>
          <div id="lotTable"></div>
          <div class="toolbar">
            <button class="btn btn-ghost" onclick="addLotRow()">+ Add Lot</button>
          </div>
        </div>

        <div class="row row-1">
          <div>
            <label>Note</label>
            <textarea id="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô OK / NG / Remark"></textarea>
          </div>
        </div>

        <div class="toolbar">
          <span id="loginBadge" class="badge"></span>
          <button class="btn" onclick="onLogout()">Logout</button>
          <button class="btn btn-primary" onclick="onSave()">Save</button>
        </div>
      </section>

      <!-- HISTORY SCREEN -->
      <section id="screen-history" class="section screen">
        <div class="row">
          <div>
            <label>Start date</label>
            <input type="date" id="hStart" />
          </div>
          <div>
            <label>End date</label>
            <input type="date" id="hEnd" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Part No. (filter)</label>
            <input id="hPartNo" list="partNoList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ" />
          </div>
          <div>
            <label>Employee (filter)</label>
            <input id="hEmployee" placeholder="‡πÄ‡∏ä‡πà‡∏ô Champ" />
          </div>
        </div>
        <div class="toolbar" style="justify-content:space-between">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="resetHistoryFilters()">Reset</button>
            <button class="btn btn-primary" onclick="loadHistory()">Search</button>
            <button class="btn btn-ghost" onclick="exportHistoryCSV()">Export CSV</button>
          </div>
          <div>
            <span class="muted" id="historyMeta"></span>
          </div>
        </div>
        <div style="margin-top:14px">
          <div id="historyTable" class="table-wrap"></div>
        </div>
        <div class="toolbar" style="justify-content:flex-end">
          <button class="btn" onclick="showScreen('screen-form')">Back to Form</button>
        </div>
      </section>

      <!-- DASHBOARD SCREEN -->
      <section id="screen-dashboard" class="section screen">
        <div class="row">
          <div>
            <label>Start date</label>
            <input type="date" id="dStart" />
          </div>
          <div>
            <label>End date</label>
            <input type="date" id="dEnd" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Part No. (filter)</label>
            <input id="dPartNo" list="partNoList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ" />
          </div>
          <div>
            <label>Employee (filter)</label>
            <input id="dEmployee" placeholder="‡πÄ‡∏ä‡πà‡∏ô Champ" />
          </div>
        </div>
        <div class="toolbar" style="justify-content:space-between">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="resetDashboardFilters()">Reset</button>
            <button class="btn btn-primary" onclick="loadDashboard()">Update</button>
          </div>
          <div><span class="muted" id="dashMeta"></span></div>
        </div>

        <div class="kpi" style="margin-top:14px">
          <div class="cardk">
            <div class="title">Total Records</div>
            <div class="value" id="kpiRecords">-</div>
          </div>
          <div class="cardk">
            <div class="title">Total Quantity</div>
            <div class="value" id="kpiQty">-</div>
          </div>
          <div class="cardk">
            <div class="title">Unique Parts</div>
            <div class="value" id="kpiParts">-</div>
          </div>
          <div class="cardk">
            <div class="title">Employees</div>
            <div class="value" id="kpiEmployees">-</div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:16px">
          <div class="table-wrap" id="tblByPart"></div>
          <div class="table-wrap" id="tblByEmployee"></div>
        </div>

        <div style="margin-top:16px" class="table-wrap" id="tblByShift"></div>

        <div style="margin-top:16px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
          <div class="muted" style="margin-bottom:6px">Daily Quantity</div>
          <canvas id="dailyChart" width="900" height="320"></canvas>
        </div>

        <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" onclick="showScreen('screen-form')">Back to Form</button>
        </div>
      </section>

    </div>
  </div>

  <!-- Modal / Popup -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle">Message</h3>
      <p id="modalBody">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
      <div class="actions">
        <button class="btn" onclick="closeModal()">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIG ====
    const API_URL = "https://script.google.com/macros/s/AKfycbwkg5bdMIXQuVMG9Z20eGB2olNo1OSZGYUseNZT4Ux58S34aeV2W6YsnVLwCWMoZVQQ/exec"; // ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å GAS Deploy (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec)

    // Master data: ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï `part_list` ‡∏ú‡πà‡∏≤‡∏ô GAS
    let PARTS = {};
    let PARTS_LC = {};
    function normalizeKey(s){ return (s||'').toString().trim().toLowerCase(); }

    // ‡πÇ‡∏´‡∏•‡∏î part list ‡∏à‡∏≤‡∏Å GAS
    async function loadParts(){
      try{
        const resp = await fetch(API_URL + '?action=parts');
        const data = await resp.json().catch(()=>({ok:false,error:'Invalid JSON'}));
        if(!data.ok){ console.warn('Load parts failed:', data.error); return; }
        PARTS = {};
        PARTS_LC = {};
        for(const p of (data.parts||[])){
          if(p && p.partNo){
            const no = String(p.partNo);
            const name = String(p.partName||'');
            PARTS[no] = name;
            PARTS_LC[normalizeKey(no)] = name;
          }
        }
        fillPartNoList();
      }catch(err){ console.warn('Load parts error:', err); }
    }

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° datalist ‡∏Ç‡∏≠‡∏á Part No.
    function fillPartNoList(){
      const dl = document.getElementById('partNoList');
      dl.innerHTML = '';
      Object.keys(PARTS).forEach(k=>{
        const opt = document.createElement('option');
        opt.value = k;
        dl.appendChild(opt);
      });
    }

    // ==== View helpers ====
    function showScreen(id){
      for (const el of document.querySelectorAll('.screen')) el.classList.remove('active');
      document.getElementById(id).classList.add('active');
    }
    function showModal(title, body){
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = body;
      document.getElementById('overlay').classList.add('show');
    }
    function closeModal(){ document.getElementById('overlay').classList.remove('show'); }

    // History helpers
    function openHistory(){
      showScreen('screen-history');
      if(!openHistory._loaded){ loadHistory(); openHistory._loaded = true; }
    }
    function resetHistoryFilters(){
      document.getElementById('hStart').value = '';
      document.getElementById('hEnd').value = '';
      document.getElementById('hPartNo').value = '';
      document.getElementById('hEmployee').value = '';
    }

    // Dashboard helpers
    function openDashboard(){
      showScreen('screen-dashboard');
      if(!openDashboard._loaded){ loadDashboard(); openDashboard._loaded = true; }
    }
    function resetDashboardFilters(){
      document.getElementById('dStart').value = '';
      document.getElementById('dEnd').value = '';
      document.getElementById('dPartNo').value = '';
      document.getElementById('dEmployee').value = '';
    }

    // ==== Login (MVP stub) ====
    function onLogin(){
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value; // not used in MVP
      if(!u){ return showModal('Login failed', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username'); }
      localStorage.setItem('loggedUser', u);
      document.getElementById('employee').value = u;
      document.getElementById('loginBadge').textContent = `Logged in as: ${u}`;
      showScreen('screen-form');
    }
    function onLogout(){
      localStorage.removeItem('loggedUser');
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      showScreen('screen-login');
    }

    // ==== Part link ====
    function updatePartName(){
      const pnRaw = document.getElementById('partNo').value;
      const pn = pnRaw.trim();
      const name = PARTS[pn] || PARTS_LC[normalizeKey(pn)] || '';
      document.getElementById('partName').value = name;
    }

    // ==== Lots table ====
    function lotRowTemplate(idx){
      return `
        <div class="lot-row" data-index="${idx}">
          <input placeholder="Lot No." class="lot-no" />
          <input type="number" min="0" step="1" placeholder="Qty" class="lot-qty" />
          <div class="lot-actions">
            <button class="btn btn-danger" onclick="removeLotRow(${idx})">Remove</button>
          </div>
        </div>
      `;
    }
    let lotIndex = 0;
    function addLotRow(){
      const wrap = document.getElementById('lotTable');
      const div = document.createElement('div');
      div.innerHTML = lotRowTemplate(++lotIndex);
      wrap.appendChild(div.firstElementChild);
    }
    function removeLotRow(idx){
      const row = document.querySelector(`.lot-row[data-index="${idx}"]`);
      if(row) row.remove();
    }
    function clearLots(){
      document.getElementById('lotTable').innerHTML = '';
      lotIndex = 0; addLotRow();
    }

    // ==== Save ====
    async function onSave(){
      try{
        const employee = document.getElementById('employee').value.trim();
        const partNo   = document.getElementById('partNo').value.trim();
        const partName = document.getElementById('partName').value.trim();
        const shift    = document.getElementById('shift').value;
        const note     = document.getElementById('note').value.trim();
        const userId   = employee ? (employee.toLowerCase().replace(/\s+/g,'')) : '';

        const lots = Array.from(document.querySelectorAll('.lot-row')).map(r=>({
          lotNo: r.querySelector('.lot-no').value.trim(),
          quantity: Number(r.querySelector('.lot-qty').value || '0')
        })).filter(x=>x.lotNo);

        if(!employee || !partNo || lots.length===0){
          return showModal('Invalid form', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Employee, Part No. ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á Lot/Quantity');
        }

        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ß‡πà‡∏≤ Part No. ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô part_list
        const exists = !!(PARTS[partNo] || PARTS_LC[normalizeKey(partNo)]);
        if(!exists){
          return showModal('Invalid Part', 'Part No. ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å part_list');
        }

        const payload = { employee, userId, partNo, partName, shift, note, lots };

        const resp = await fetch(API_URL, { method:'POST', body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=>({ok:false,error:'Invalid JSON response'}));

        if(!data.ok){
          return showModal('Save failed', data.error || 'Unknown error');
        }

        showModal('Saved successfully!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        document.getElementById('partNo').value = '';
        document.getElementById('partName').value = '';
        document.getElementById('note').value = '';
        clearLots();

      }catch(err){
        showModal('Save failed', String(err));
      }
    }

    // ==== History ====
    function buildQuery(params){
      const usp = new URLSearchParams();
      Object.entries(params).forEach(([k,v])=>{ if(v!=null && v!=='') usp.set(k,v); });
      return usp.toString();
    }
    function renderHistoryTable(rows){
      const host = document.getElementById('historyTable');
      if(!rows || rows.length===0){ host.innerHTML = '<div class="muted" style="padding:16px">No records</div>'; return; }
      let html = '<table style="width:100%">';
      html += '<thead><tr style="text-align:left">'
            + '<th style="padding:10px">Timestamp</th>'
            + '<th style="padding:10px">Employee</th>'
            + '<th style="padding:10px">Part No.</th>'
            + '<th style="padding:10px">Part Name</th>'
            + '<th style="padding:10px">Lot No.</th>'
            + '<th style="padding:10px;text-align:right">Qty</th>'
            + '<th style="padding:10px">Shift</th>'
            + '<th style="padding:10px">Note</th>'
            + '</tr></thead><tbody>';
      for(const r of rows){
        html += '<tr>'
          + `<td style="padding:8px;white-space:nowrap">${r.Timestamp || ''}</td>`
          + `<td style="padding:8px">${r.Employee || ''}</td>`
          + `<td style="padding:8px">${r['Part No.'] || ''}</td>`
          + `<td style="padding:8px">${r['Part Name'] || ''}</td>`
          + `<td style="padding:8px">${r['Lot No.'] || ''}</td>`
          + `<td style="padding:8px;text-align:right">${r.Quantity ?? ''}</td>`
          + `<td style="padding:8px">${r.Shift || ''}</td>`
          + `<td style="padding:8px">${r.Note || ''}</td>`
          + '</tr>';
      }
      html += '</tbody></table>';
      host.innerHTML = html;
    }
    async function loadHistory(){
      const p = {
        action: 'history',
        start: document.getElementById('hStart').value,
        end: document.getElementById('hEnd').value,
        partNo: document.getElementById('hPartNo').value.trim(),
        employee: document.getElementById('hEmployee').value.trim(),
        limit: 2000
      };
      const url = API_URL + '?' + buildQuery(p);
      try{
        const resp = await fetch(url);
        const data = await resp.json().catch(()=>({ok:false,error:'Invalid JSON'}));
        if(!data.ok){
          document.getElementById('historyMeta').textContent = 'Error';
          return showModal('Load failed', data.error || 'Unknown error');
        }
        document.getElementById('historyMeta').textContent = `Total: ${data.total} | Showing: ${data.rows.length}`;
        renderHistoryTable(data.rows);
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ export ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥
        loadHistory._lastRows = data.rows || [];
      }catch(err){
        showModal('Load failed', String(err));
      }
    }
    function toCSV(rows){
      if(!rows || rows.length===0) return '';
      const headers = ['Timestamp','Employee','Part No.','Part Name','Lot No.','Quantity','Shift','Note'];
      const esc = (v) => {
        const s = (v==null) ? '' : String(v);
        const needQuote = /[",\n]/.test(s);
        const body = s.replace(/"/g,'""');
        return needQuote ? `"${body}"` : body;
      };
      let lines = [];
      lines.push(headers.map(esc).join(','));
      for(const r of rows){
        lines.push(headers.map(h=>esc(r[h])).join(','));
      }
      // ‡πÉ‡∏™‡πà BOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ñ‡∏π‡∏Å
      return '\uFEFF' + lines.join('\r\n');
    }
    function downloadCSV(filename, content){
      const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    async function exportHistoryCSV(){
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î Search ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      if(!loadHistory._lastRows){ await loadHistory(); }
      const rows = loadHistory._lastRows || [];
      if(rows.length === 0){
        return showModal('Export CSV', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î Search ‡∏Å‡πà‡∏≠‡∏ô)');
      }
      const csv = toCSV(rows);
      const start = document.getElementById('hStart').value || 'all';
      const end = document.getElementById('hEnd').value || 'all';
      const filename = `inspection_history_${start}_to_${end}.csv`;
      downloadCSV(filename, csv);
    }

    // ==== Dashboard ====
    function numberFmt(n){ return (n==null||n==='') ? '-' : new Intl.NumberFormat().format(n); }
    function renderTable(containerId, title, rows, cols){
      const host = document.getElementById(containerId);
      if(!rows || rows.length===0){ host.innerHTML = `<div class="muted" style="padding:12px">${title}: No data</div>`; return; }
      let html = `<div class="muted" style="padding:8px 12px">${title}</div>`;
      html += '<table style="width:100%"><thead><tr style="text-align:left">';
      for(const c of cols){ html += `<th style="padding:10px">${c}</th>`; }
      html += '</tr></thead><tbody>';
      for(const r of rows){
        html += '<tr>';
        for(const c of cols){
          const v = r[c];
          const padRight = (c.toLowerCase().includes('qty') || c.toLowerCase().includes('records')) ? 'text-align:right' : '';
          html += `<td style="padding:8px;${padRight}">${v ?? ''}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      host.innerHTML = html;
    }
    function renderDailyChart(points){
      const canvas = document.getElementById('dailyChart');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!points || points.length===0){ ctx.fillText('No data', 10, 20); return; }

      const m = {l:50, r:10, t:10, b:40};
      const W = canvas.width - m.l - m.r;
      const H = canvas.height - m.t - m.b;

      const maxY = Math.max(...points.map(p=>Number(p.qty)||0), 10);
      const xStep = W / points.length;
      const barW = Math.max(8, xStep * 0.6);

      ctx.strokeStyle = '#94a3b8';
      ctx.beginPath();
      ctx.moveTo(m.l, m.t);
      ctx.lineTo(m.l, m.t + H);
      ctx.lineTo(m.l + W, m.t + H);
      ctx.stroke();

      ctx.fillStyle = '#64748b';
      ctx.font = '12px sans-serif';
      const ticks = 5;
      for(let i=0;i<=ticks;i++){
        const yVal = Math.round(maxY * (i/ticks));
        const y = m.t + H - (yVal / maxY) * H;
        ctx.fillText(numberFmt(yVal), 8, y+4);
        ctx.strokeStyle = '#e2e8f0';
        ctx.beginPath();
        ctx.moveTo(m.l, y);
        ctx.lineTo(m.l + W, y);
        ctx.stroke();
      }

      ctx.fillStyle = '#1e88e5';
      points.forEach((p,idx)=>{
        const xCenter = m.l + xStep*idx + xStep/2;
        const yVal = Number(p.qty)||0;
        const h = (yVal / maxY) * H;
        const x = xCenter - barW/2;
        const y = m.t + H - h;
        ctx.fillRect(x, y, barW, h);
      });

      ctx.fillStyle = '#64748b';
      ctx.textAlign = 'center';
      points.forEach((p,idx)=>{
        const xCenter = m.l + xStep*idx + xStep/2;
        ctx.fillText(p.date, xCenter, m.t + H + 16);
      });
      ctx.textAlign = 'left';
    }

    async function loadDashboard(){
      const p = {
        action: 'dashboard',
        start: document.getElementById('dStart').value,
        end: document.getElementById('dEnd').value,
        partNo: document.getElementById('dPartNo').value.trim(),
        employee: document.getElementById('dEmployee').value.trim(),
      };
      const url = API_URL + '?' + buildQuery(p);
      try{
        const resp = await fetch(url);
        const data = await resp.json().catch(()=>({ok:false,error:'Invalid JSON'}));
        if(!data.ok){ document.getElementById('dashMeta').textContent = 'Error'; return showModal('Dashboard error', data.error||'Unknown'); }

        document.getElementById('kpiRecords').textContent = numberFmt(data.totals.records);
        document.getElementById('kpiQty').textContent = numberFmt(data.totals.totalQty);
        document.getElementById('kpiParts').textContent = numberFmt(data.totals.uniqueParts);
        document.getElementById('kpiEmployees').textContent = numberFmt(data.totals.employees);

        renderTable('tblByPart', 'By Part', data.byPart, ['Part No.','Part Name','Records','Qty']);
        renderTable('tblByEmployee', 'By Employee', data.byEmployee, ['Employee','Records','Qty']);
        renderTable('tblByShift', 'By Shift', data.byShift, ['Shift','Records','Qty']);

        renderDailyChart(data.daily || []);
        document.getElementById('dashMeta').textContent = `Range: ${data.range || '-'} | Records: ${numberFmt(data.totals.records)}`;

      }catch(err){
        showModal('Dashboard error', String(err));
      }
    }

    // ==== init ====
    (async function init(){
      await loadParts(); // ‡πÇ‡∏´‡∏•‡∏î part_list ‡∏Å‡πà‡∏≠‡∏ô
      const u = localStorage.getItem('loggedUser');
      if(u){
        document.getElementById('employee').value = u;
        document.getElementById('loginBadge').textContent = `Logged in as: ${u}`;
        showScreen('screen-form');
      } else {
        showScreen('screen-login');
      }
      clearLots();
    })();
  </script>
</body>
</html>
