<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspection System ‚Äî MVP</title>
  <style>
    :root{--bg1:#0b2a55;--bg2:#134b8a;--accent:#1e88e5;--card:#ffffff;--muted:#6b7280;--danger:#c62828}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100dvh;color:#0f172a;display:flex;align-items:center;justify-content:center}
    .container{width:min(1100px,95vw);}
    .card{background:var(--card);border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden}
    header{padding:28px 28px 18px;color:#e3f2fd;text-align:center}
    header h1{margin:0;font-weight:700;font-size:clamp(20px,3.6vw,28px)}
    header p{margin:.35rem 0 0;color:#cfe8ff}
    .section{padding:20px clamp(16px,4vw,28px) 26px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:13px;color:#334155;margin:6px 2px}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(30,136,229,.15)}
    .muted{color:var(--muted);font-size:12px}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:white}
    .btn-ghost{background:transparent;color:var(--accent);border:1px dashed var(--accent)}
    .btn-danger{background:var(--danger);color:#fff}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:flex-start;margin-top:10px;flex-wrap:wrap}
    .badge{background:#e8f2ff;color:#0b3a72;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600}
    .screen{display:none}.screen.active{display:block}
    .table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:12px}
    .login-hero{padding:28px;text-align:center;color:white}
    .login-hero h2{margin:0 0 6px;font-size:clamp(22px,6vw,30px)}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <header>
      <h1>Inspection System</h1>
      <p>GitHub Pages + Google Apps Script</p>
    </header>

    <!-- Top Nav -->
    <div class="section" style="padding-top:8px;padding-bottom:0">
      <div class="toolbar">
        <button class="btn btn-ghost" onclick="showScreen('screen-form')">‚ûï New Entry</button>
        <button id="btnHistory" class="btn btn-ghost" onclick="openHistory()" disabled>üìú History / Search</button>
        <button id="btnDashboard" class="btn btn-ghost" onclick="openDashboard()" disabled>üìä Dashboard</button>
        <span style="flex:1"></span>
        <span id="loginBadge" class="badge"></span>
        <button class="btn" onclick="onLogout()">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section id="screen-login" class="section screen active">
      <div class="login-hero">
        <h2>üîê Login</h2>
        <p>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á History/Dashboard ‡πÑ‡∏î‡πâ</p>
      </div>
      <div class="row">
        <div><label>Username</label><input id="login-username" placeholder="‡πÄ‡∏ä‡πà‡∏ô champ" autocomplete="username"/></div>
        <div><label>Password</label><input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" onclick="doLogin()">Login</button>
        <span class="muted">* ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: operator / viewer / admin</span>
      </div>
    </section>

    <!-- FORM -->
    <section id="screen-form" class="section screen">
      <div class="row">
        <div><label>Employee</label><input id="employee" readonly /></div>
        <div><label>Shift</label>
          <select id="shift"><option value="A">A</option><option value="B">B</option></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Part No.</label>
          <input id="partNo" list="partNoList" placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC-123" oninput="updatePartName()" onchange="updatePartName()" />
          <datalist id="partNoList"></datalist>
        </div>
        <div>
          <label>Part Name</label>
          <input id="partName" readonly tabindex="-1" onfocus="this.blur()" inputmode="none" style="background:#f8fafc;cursor:not-allowed" placeholder="‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Part No."/>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Lots & Quantity</label>
        <div id="lotTable"></div>
        <div class="toolbar"><button class="btn btn-ghost" onclick="addLotRow()">+ Add Lot</button></div>
      </div>

      <div class="row row-1">
        <div><label>Note</label><textarea id="note" rows="3" placeholder="OK/NG/Remark"></textarea></div>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" onclick="onSave()">Save</button>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="screen-history" class="section screen">
      <div class="row">
        <div><label>Start date</label><input type="date" id="hStart" /></div>
        <div><label>End date</label><input type="date" id="hEnd" /></div>
      </div>
      <div class="row">
        <div><label>Part No. (filter)</label><input id="hPartNo" list="partNoList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ" /></div>
        <div><label>Employee (filter)</label><input id="hEmployee" placeholder="‡πÄ‡∏ä‡πà‡∏ô Champ" /></div>
      </div>
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="resetHistoryFilters()">Reset</button>
          <button class="btn btn-primary" onclick="loadHistory()">Search</button>
          <button class="btn btn-ghost" onclick="exportHistoryCSV()">Export CSV</button>
        </div>
        <div><span class="muted" id="historyMeta"></span></div>
      </div>
      <div style="margin-top:14px"><div id="historyTable" class="table-wrap"></div></div>
      <div class="toolbar" style="justify-content:flex-end"><button class="btn" onclick="showScreen('screen-form')">Back to Form</button></div>
    </section>

    <!-- DASHBOARD -->
    <section id="screen-dashboard" class="section screen">
      <div class="row">
        <div><label>Start date</label><input type="date" id="dStart" /></div>
        <div><label>End date</label><input type="date" id="dEnd" /></div>
      </div>
      <div class="row">
        <div><label>Part No. (filter)</label><input id="dPartNo" list="partNoList" /></div>
        <div><label>Employee (filter)</label><input id="dEmployee" /></div>
      </div>
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="resetDashboardFilters()">Reset</button>
          <button class="btn btn-primary" onclick="loadDashboard()">Update</button>
        </div>
        <div><span class="muted" id="dashMeta"></span></div>
      </div>

      <div class="table-wrap" id="tblByPart" style="margin-top:14px"></div>
      <div class="table-wrap" id="tblByEmployee" style="margin-top:14px"></div>
      <div class="table-wrap" id="tblByShift" style="margin-top:14px"></div>
      <div class="table-wrap" id="tblByLot" style="margin-top:14px"></div>
    </section>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxzJ9aO_GNv1Y6hJJ2NipqWw6QTmbA0vsBPKg3RWBRaFETcDzLbpmuluqIxEyVIGm9n/exec"; // ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec
  const el = id => document.getElementById(id);
  const bust = ()=>'_='+Date.now();
  const withBust = url => url + (url.includes('?')?'&':'?') + bust();

  // ---- Auth state ----
  function getAuth(){ try{ return JSON.parse(localStorage.getItem('auth')||'{}'); }catch(_){ return {}; } }
  function setAuth(a){ localStorage.setItem('auth', JSON.stringify(a||{})); }
  function clearAuth(){ localStorage.removeItem('auth'); }

  function applyRoleUI(){
    const auth = getAuth();
    const role = (auth.role||'').toLowerCase();
    el('loginBadge').textContent = auth.username ? `Logged in as: ${auth.username} (${role||'-'})` : '';
    const canView = role === 'viewer' || role === 'admin';
    el('btnHistory').disabled = !canView;
    el('btnDashboard').disabled = !canView;
  }

  // ---- Date helpers (short) ----
  function parseYMD(s){ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); } const t=new Date(s); return isNaN(t)?null:t; }
  function fmtShortDMY(dLike){ const d = dLike instanceof Date ? dLike : parseYMD(dLike); if(!d) return ''; return `${d.getDate()}-${d.getMonth()+1}-${String(d.getFullYear()).slice(-2)}`; }
  function shortIfDate(v){ const s=fmtShortDMY(v); return s|| (v??''); }
  function numberFmt(n){ return (n==null||n==='')?'-':new Intl.NumberFormat().format(n); }

  // ---- Login / Logout ----
  async function doLogin(){
    try{
      const username = el('login-username').value.trim();
      const password = el('login-password').value;
      if(!username || !password){ alert('‡∏Å‡∏£‡∏≠‡∏Å Username/Password'); return; }
      const resp = await fetch(API_URL, { method:'POST', body: JSON.stringify({ action:'login', username, password }) });
      const data = await resp.json();
      if(!data.ok){ alert('Login failed: ' + (data.error||'')); return; }
      setAuth({ token: data.token, username: data.user.username, role: data.user.role });
      el('employee').value = data.user.username;
      el('login-username').value=''; el('login-password').value='';
      applyRoleUI();
      await loadParts(); // ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á parts ‡∏´‡∏•‡∏±‡∏á login ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ token
      showScreen('screen-form');
    }catch(err){ alert('Login error: ' + err); }
  }
  function onLogout(){
    const { token } = getAuth();
    clearAuth();
    applyRoleUI();
    showScreen('screen-login');
    // (optional) ‡πÅ‡∏à‡πâ‡∏á backend ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ token
    if(token){ fetch(API_URL, { method:'POST', body: JSON.stringify({ action:'logout', token }) }).catch(()=>{}); }
  }

  // ---- Screens ----
  function showScreen(id){
    document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
    el(id).classList.add('active');
  }
  function openHistory(){ showScreen('screen-history'); if(!openHistory._loaded){ loadHistory(); openHistory._loaded=true; } }
  function openDashboard(){ showScreen('screen-dashboard'); if(!openDashboard._loaded){ loadDashboard(); openDashboard._loaded=true; } }
  function resetHistoryFilters(){ el('hStart').value=''; el('hEnd').value=''; el('hPartNo').value=''; el('hEmployee').value=''; }
  function resetDashboardFilters(){ el('dStart').value=''; el('dEnd').value=''; el('dPartNo').value=''; el('dEmployee').value=''; }

  // ---- Parts ----
  let PARTS = {}, PARTS_LC = {};
  const normalizeKey = s => (s||'').toString().trim().toLowerCase();

  async function loadParts(){
    try{
      const { token } = getAuth();
      if(!token) return;
      const url = `${API_URL}?action=parts&token=${encodeURIComponent(token)}`;
      const resp = await fetch(withBust(url));
      const data = await resp.json();
      if(!data.ok){ console.warn('parts error', data.error); return; }
      PARTS = {}; PARTS_LC = {};
      (data.parts||[]).forEach(p=>{
        PARTS[String(p.partNo)] = String(p.partName||'');
        PARTS_LC[normalizeKey(p.partNo)] = String(p.partName||'');
      });
      const dl = el('partNoList'); dl.innerHTML='';
      Object.keys(PARTS).forEach(k=>{ const o=document.createElement('option'); o.value=k; dl.appendChild(o); });
    }catch(e){ console.warn(e); }
  }
  function updatePartName(){
    const pn = el('partNo').value.trim();
    el('partName').value = PARTS[pn] || PARTS_LC[normalizeKey(pn)] || '';
  }

  // ---- Lots ----
  function lotRowTemplate(i){ return `<div class="lot-row" data-index="${i}">
    <input placeholder="Lot No." class="lot-no" />
    <input type="number" min="0" step="1" placeholder="Qty" class="lot-qty" />
    <div class="lot-actions"><button class="btn btn-danger" onclick="removeLotRow(${i})">Remove</button></div>
  </div>`;}
  let lotIndex=0;
  function addLotRow(){ const d=document.createElement('div'); d.innerHTML=lotRowTemplate(++lotIndex); el('lotTable').appendChild(d.firstElementChild); }
  function removeLotRow(i){ const row=document.querySelector(`.lot-row[data-index="${i}"]`); if(row) row.remove(); }
  function clearLots(){ el('lotTable').innerHTML=''; lotIndex=0; addLotRow(); }

  // ---- Save ----
  async function onSave(){
    try{
      const auth = getAuth();
      if(!auth.token){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const employee = el('employee').value.trim();
      const partNo = el('partNo').value.trim();
      const partName = el('partName').value.trim();
      const shift = el('shift').value;
      const note = el('note').value.trim();
      const userId = employee ? employee.toLowerCase().replace(/\s+/g,'') : '';

      const lots = Array.from(document.querySelectorAll('.lot-row')).map(r=>({
        lotNo: r.querySelector('.lot-no').value.trim(),
        quantity: Number(r.querySelector('.lot-qty').value||'0')
      })).filter(x=>x.lotNo);

      if(!employee || !partNo || lots.length===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Employee, Part No. ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á Lot/Quantity'); return; }
      if(!(PARTS[partNo] || PARTS_LC[normalizeKey(partNo)])){ alert('Part No. ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

      const payload = { token: auth.token, employee, userId, partNo, partName, shift, note, lots };
      const resp = await fetch(API_URL, { method:'POST', body: JSON.stringify(payload) });
      const data = await resp.json();
      if(!data.ok){ alert('Save failed: ' + (data.error||'')); return; }

      alert('Saved!');
      el('partNo').value=''; el('partName').value=''; el('note').value=''; clearLots();
    }catch(err){ alert('Save error: ' + err); }
  }

  // ---- History ----
  function renderHistoryTable(rows){
    const host = el('historyTable');
    if(!rows || rows.length===0){ host.innerHTML = '<div class="muted" style="padding:16px">No records</div>'; return; }
    let html = '<table style="width:100%"><thead><tr style="text-align:left">'
      + '<th style="padding:10px">Date</th>'
      + '<th style="padding:10px">Employee</th>'
      + '<th style="padding:10px">Part No.</th>'
      + '<th style="padding:10px">Part Name</th>'
      + '<th style="padding:10px">Lot No.</th>'
      + '<th style="padding:10px;text-align:right">Qty</th>'
      + '<th style="padding:10px">Shift</th>'
      + '<th style="padding:10px">Note</th>'
      + '</tr></thead><tbody>';
    for(const r of rows){
      const d = shortIfDate(r.Timestamp);
      const lot = shortIfDate(r['Lot No.']);
      html += '<tr>'
        + `<td style="padding:8px;white-space:nowrap">${d}</td>`
        + `<td style="padding:8px">${r.Employee||''}</td>`
        + `<td style="padding:8px">${r['Part No.']||''}</td>`
        + `<td style="padding:8px">${r['Part Name']||''}</td>`
        + `<td style="padding:8px">${lot}</td>`
        + `<td style="padding:8px;text-align:right">${r.Quantity??''}</td>`
        + `<td style="padding:8px">${r.Shift||''}</td>`
        + `<td style="padding:8px">${r.Note||''}</td>`
        + '</tr>';
    }
    html += '</tbody></table>';
    host.innerHTML = html;
  }
  async function loadHistory(){
    try{
      const { token } = getAuth();
      if(!token){ alert('‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const q = new URLSearchParams({
        action:'history',
        token,
        start: el('hStart').value || '',
        end: el('hEnd').value || '',
        partNo: el('hPartNo').value.trim(),
        employee: el('hEmployee').value.trim(),
        limit: '2000'
      });
      const resp = await fetch(withBust(API_URL + '?' + q.toString()));
      const data = await resp.json();
      if(!data.ok){ el('historyMeta').textContent='Error'; alert(data.error||'Load failed'); return; }
      el('historyMeta').textContent = `Total: ${data.total} | Showing: ${data.rows.length}`;
      renderHistoryTable(data.rows);
      loadHistory._rows = data.rows;
    }catch(err){ alert('Load error: ' + err); }
  }
  function toCSVShortDate(rows){
    if(!rows || rows.length===0) return '';
    const headers = ['Date','Employee','Part No.','Part Name','Lot No.','Quantity','Shift','Note'];
    const esc = v=>{ const s=(v==null)?'':String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; };
    const lines=[headers.join(',')];
    for(const r of rows){
      const row = [ shortIfDate(r.Timestamp), r.Employee, r['Part No.'], r['Part Name'], shortIfDate(r['Lot No.']), r.Quantity, r.Shift, r.Note ];
      lines.push(row.map(esc).join(','));
    }
    return '\uFEFF' + lines.join('\r\n');
  }
  async function exportHistoryCSV(){
    if(!loadHistory._rows) await loadHistory();
    const rows = loadHistory._rows || [];
    if(rows.length===0){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'); return; }
    const start = el('hStart').value ? fmtShortDMY(el('hStart').value) : 'all';
    const end   = el('hEnd').value ? fmtShortDMY(el('hEnd').value) : 'all';
    const blob = new Blob([toCSVShortDate(rows)], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`inspection_history_${start}_to_${end}.csv`; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  }

  // ---- Dashboard ----
  function renderTable(containerId, title, rows, cols){
    const host=el(containerId);
    if(!rows || rows.length===0){ host.innerHTML=`<div class="muted" style="padding:12px">${title}: No data</div>`; return; }
    let html=`<div class="muted" style="padding:8px 12px">${title}</div><table style="width:100%"><thead><tr style="text-align:left">`;
    cols.forEach(c=>html+=`<th style="padding:10px">${c}</th>`); html+='</tr></thead><tbody>';
    rows.forEach(r=>{ html+='<tr>'; cols.forEach(c=>{ const v=(c==='Lot No.')?shortIfDate(r[c]):r[c]; const pr=(/qty|records/i.test(c)?'text-align:right':''); html+=`<td style="padding:8px;${pr}">${v??''}</td>`; }); html+='</tr>'; });
    html+='</tbody></table>'; host.innerHTML=html;
  }
  async function loadDashboard(){
    try{
      const { token } = getAuth();
      if(!token){ alert('‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const q = new URLSearchParams({
        action:'dashboard',
        token,
        start: el('dStart').value || '',
        end: el('dEnd').value || '',
        partNo: el('dPartNo').value.trim(),
        employee: el('dEmployee').value.trim()
      });
      const resp = await fetch(withBust(API_URL + '?' + q.toString()));
      const data = await resp.json();
      if(!data.ok){ el('dashMeta').textContent='Error'; alert(data.error||'Load failed'); return; }

      renderTable('tblByPart','By Part',data.byPart,['Part No.','Part Name','Records','Qty']);
      renderTable('tblByEmployee','By Employee',data.byEmployee,['Employee','Records','Qty']);
      renderTable('tblByShift','By Shift',data.byShift,['Shift','Records','Qty']);
      renderTable('tblByLot','By Lot (Top 100)', (data.byLot||[]).slice(0,100), ['Lot No.','Part No.','Part Name','Records','Qty']);

      const rangeText = (el('dStart').value||el('dEnd').value) ? `${el('dStart').value?fmtShortDMY(el('dStart').value):'...'} ‚Üí ${el('dEnd').value?fmtShortDMY(el('dEnd').value):'...'}` : 'All time';
      el('dashMeta').textContent = `Range: ${rangeText} | Records: ${numberFmt(data.totals.records)}`;
    }catch(err){ alert('Dashboard error: ' + err); }
  }

  // ---- Init ----
  (async function init(){
    applyRoleUI();
    const auth = getAuth();
    if(auth && auth.token){
      el('employee').value = auth.username || '';
      await loadParts();
      showScreen('screen-form');
    } else {
      showScreen('screen-login');
    }
    clearLots();
  })();
</script>
</body>
</html>
